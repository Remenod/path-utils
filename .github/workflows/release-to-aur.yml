name: Release to AUR

on:
  workflow_run:
    workflows: ["Check PKGBUILD"]
    types: [completed]

jobs:
  bump-and-push:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}

    runs-on: ubuntu-latest
    container: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install base-devel and devtools
        run: |
          pacman -Syu --noconfirm --needed base-devel devtools git sudo

      - name: Set up SSH key
        run: |
          mkdir -p /root/.ssh
          echo "${{ secrets.AUR_SSH_KEY }}" > /root/.ssh/id_ed25519
          chmod 600 /root/.ssh/id_ed25519

          cat <<EOF > /root/.ssh/config
          Host aur.archlinux.org
            User aur
            IdentityFile /root/.ssh/id_ed25519
            StrictHostKeyChecking no
          EOF

      - name: Create builder user
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder .

      - name: Increment pkgrel
        id: bump
        run: |
          current=$(grep "^pkgrel=" PKGBUILD | cut -d= -f2)
          new=$((current + 1))

          sudo -u builder sed -i "s/^pkgrel=.*/pkgrel=$new/" PKGBUILD

          echo "Bumped pkgrel: $current â†’ $new"

          echo "new=$new" >> $GITHUB_ENV

      - name: Generate .SRCINFO
        run: |
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Configure Git for builder
        run: |
          sudo -u builder git config --global user.name "github-actions"
          sudo -u builder git config --global user.email "github-actions@github.com"

      - name: Add AUR remote
        run: |
          run: sudo -u builder git -C "$GITHUB_WORKSPACE" remote add aur ssh://aur@aur.archlinux.org/path-utils.git

      - name: Commit changes
        run: |
          sudo -u builder git -C "$GITHUB_WORKSPACE" add PKGBUILD .SRCINFO
          sudo -u builder git -C "$GITHUB_WORKSPACE" commit -m "Bump pkgrel to ${{ env.new }} [skip ci]" || echo "No changes to commit"
          
      - name: Push to AUR
        run: |
          sudo -u builder git -C "$GITHUB_WORKSPACE" push aur master
